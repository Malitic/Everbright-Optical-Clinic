<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Frontend Deletion Test</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .test-section { background: #f5f5f5; padding: 15px; margin: 10px 0; border-radius: 5px; }
        .success { border-left: 4px solid #10b981; }
        .error { border-left: 4px solid #ef4444; }
        .info { border-left: 4px solid #3b82f6; }
        button { background: #3b82f6; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin: 5px; }
        button:hover { background: #2563eb; }
        pre { background: #1e293b; color: #e2e8f0; padding: 15px; border-radius: 5px; overflow-x: auto; }
        .status { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .status.success { background: #dcfce7; color: #166534; }
        .status.error { background: #fef2f2; color: #dc2626; }
    </style>
</head>
<body>
    <h1>üîß Frontend Deletion Test</h1>
    
    <div class="test-section info">
        <h2>üìã Test Instructions</h2>
        <p>This test will help identify if the frontend is properly reflecting backend deletions.</p>
        <ol>
            <li>Click "Test API Connection" to verify backend is working</li>
            <li>Click "Check Products" to see current product list</li>
            <li>Click "Clear All Caches" to clear localStorage/sessionStorage</li>
            <li>Click "Test Deletion Event" to simulate product deletion</li>
        </ol>
    </div>

    <div class="test-section">
        <h2>üß™ Test Controls</h2>
        <button onclick="testApiConnection()">Test API Connection</button>
        <button onclick="checkProducts()">Check Products</button>
        <button onclick="clearAllCaches()">Clear All Caches</button>
        <button onclick="testDeletionEvent()">Test Deletion Event</button>
        <button onclick="checkLocalStorage()">Check localStorage</button>
    </div>

    <div class="test-section">
        <h2>üìä Test Results</h2>
        <div id="results"></div>
    </div>

    <div class="test-section">
        <h2>üîç Debug Information</h2>
        <div id="debug"></div>
    </div>

    <script>
        let authToken = null;
        
        function log(message, type = 'info') {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `status ${type}`;
            div.innerHTML = `<strong>${new Date().toLocaleTimeString()}</strong>: ${message}`;
            results.appendChild(div);
            results.scrollTop = results.scrollHeight;
        }
        
        function debug(message) {
            const debug = document.getElementById('debug');
            const div = document.createElement('div');
            div.innerHTML = `<pre>${JSON.stringify(message, null, 2)}</pre>`;
            debug.appendChild(div);
        }
        
        async function testApiConnection() {
            try {
                log('Testing API connection...', 'info');
                
                // First, try to login
                const loginResponse = await fetch('http://127.0.0.1:8000/api/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        email: 'admin@everbright.com',
                        password: 'password123',
                        role: 'admin'
                    })
                });
                
                if (!loginResponse.ok) {
                    throw new Error(`Login failed: ${loginResponse.status}`);
                }
                
                const loginData = await loginResponse.json();
                authToken = loginData.token;
                log('‚úÖ API connection successful! Token obtained.', 'success');
                debug({ token: authToken.substring(0, 20) + '...' });
                
            } catch (error) {
                log(`‚ùå API connection failed: ${error.message}`, 'error');
                debug({ error: error.message });
            }
        }
        
        async function checkProducts() {
            if (!authToken) {
                log('‚ùå Please test API connection first', 'error');
                return;
            }
            
            try {
                log('Fetching products from API...', 'info');
                
                const response = await fetch('http://127.0.0.1:8000/api/products', {
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Accept': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`API request failed: ${response.status}`);
                }
                
                const products = await response.json();
                log(`‚úÖ Found ${products.length} products from API`, 'success');
                
                // Check if product 15 (nike) exists
                const nikeProduct = products.find(p => p.id === 15);
                if (nikeProduct) {
                    log(`‚ùå Product 15 (nike) still exists in API! This shouldn't happen.`, 'error');
                } else {
                    log(`‚úÖ Product 15 (nike) correctly deleted from API`, 'success');
                }
                
                debug({ 
                    totalProducts: products.length,
                    productIds: products.map(p => p.id),
                    hasNikeProduct: !!nikeProduct
                });
                
            } catch (error) {
                log(`‚ùå Failed to fetch products: ${error.message}`, 'error');
                debug({ error: error.message });
            }
        }
        
        function clearAllCaches() {
            try {
                log('Clearing all caches...', 'info');
                
                // Clear localStorage
                const localStorageKeys = Object.keys(localStorage);
                localStorageKeys.forEach(key => {
                    if (key.includes('products') || key.includes('app_data_p') || key.includes('localStorage_products')) {
                        localStorage.removeItem(key);
                        log(`Cleared localStorage key: ${key}`, 'info');
                    }
                });
                
                // Clear sessionStorage
                const sessionStorageKeys = Object.keys(sessionStorage);
                sessionStorageKeys.forEach(key => {
                    if (key.includes('products') || key.includes('app_data_p')) {
                        sessionStorage.removeItem(key);
                        log(`Cleared sessionStorage key: ${key}`, 'info');
                    }
                });
                
                log('‚úÖ All caches cleared successfully', 'success');
                
            } catch (error) {
                log(`‚ùå Failed to clear caches: ${error.message}`, 'error');
            }
        }
        
        function testDeletionEvent() {
            try {
                log('Testing deletion event system...', 'info');
                
                // Listen for deletion events
                const listener = (event) => {
                    log(`‚úÖ Deletion event received: Product ${event.detail.productId} deleted`, 'success');
                    debug({ event: event.detail });
                };
                
                window.addEventListener('productDeleted', listener);
                
                // Dispatch test event
                const event = new CustomEvent('productDeleted', { 
                    detail: { productId: 15, test: true } 
                });
                window.dispatchEvent(event);
                
                log('‚úÖ Deletion event system working', 'success');
                
                // Clean up listener
                setTimeout(() => {
                    window.removeEventListener('productDeleted', listener);
                }, 1000);
                
            } catch (error) {
                log(`‚ùå Deletion event test failed: ${error.message}`, 'error');
            }
        }
        
        function checkLocalStorage() {
            try {
                log('Checking localStorage contents...', 'info');
                
                const allKeys = Object.keys(localStorage);
                const productKeys = allKeys.filter(key => 
                    key.includes('products') || 
                    key.includes('app_data_p') || 
                    key.includes('localStorage_products')
                );
                
                if (productKeys.length === 0) {
                    log('‚úÖ No product-related localStorage found', 'success');
                } else {
                    log(`Found ${productKeys.length} product-related localStorage keys:`, 'info');
                    productKeys.forEach(key => {
                        const value = localStorage.getItem(key);
                        log(`  - ${key}: ${value.length} characters`, 'info');
                        debug({ key, valueLength: value.length, preview: value.substring(0, 100) });
                    });
                }
                
            } catch (error) {
                log(`‚ùå Failed to check localStorage: ${error.message}`, 'error');
            }
        }
        
        // Auto-run initial tests
        window.addEventListener('load', () => {
            log('üöÄ Frontend Deletion Test loaded', 'info');
            setTimeout(() => {
                testApiConnection();
            }, 1000);
        });
    </script>
</body>
</html>
