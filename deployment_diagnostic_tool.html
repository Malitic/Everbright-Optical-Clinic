<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deployment Diagnostic Tool</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .warning { background-color: #fff3cd; border-color: #ffeaa7; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background-color: #0056b3; }
        .result {
            margin-top: 10px;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            white-space: pre-wrap;
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
        }
        .url-input {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .checklist {
            text-align: left;
            margin: 10px 0;
        }
        .checklist li {
            margin: 5px 0;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-success { background-color: #28a745; }
        .status-error { background-color: #dc3545; }
        .status-warning { background-color: #ffc107; }
        .status-info { background-color: #17a2b8; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöÄ Railway + Netlify Deployment Diagnostic Tool</h1>
        <p>This tool will help you diagnose deployment issues and get your services running.</p>

        <div class="section info">
            <h3>üìã Step 1: Enter Your URLs</h3>
            <label>Railway Backend URL:</label>
            <input type="text" id="railwayUrl" class="url-input" placeholder="https://your-backend.up.railway.app">
            
            <label>Netlify Frontend URL:</label>
            <input type="text" id="netlifyUrl" class="url-input" placeholder="https://your-site.netlify.app">
            
            <button onclick="updateUrls()">Update URLs</button>
        </div>

        <div class="section">
            <h3>üîç Step 2: Railway Backend Diagnostic</h3>
            <button onclick="diagnoseRailway()">Run Railway Diagnostic</button>
            <div id="railwayResult" class="result"></div>
        </div>

        <div class="section">
            <h3>üåê Step 3: Netlify Frontend Diagnostic</h3>
            <button onclick="diagnoseNetlify()">Run Netlify Diagnostic</button>
            <div id="netlifyResult" class="result"></div>
        </div>

        <div class="section">
            <h3>üîó Step 4: Integration Test</h3>
            <button onclick="testIntegration()">Test Integration</button>
            <div id="integrationResult" class="result"></div>
        </div>

        <div class="section">
            <h3>üìä Step 5: Deployment Checklist</h3>
            <button onclick="showChecklist()">Show Deployment Checklist</button>
            <div id="checklistResult" class="result"></div>
        </div>

        <div class="section">
            <h3>üõ†Ô∏è Step 6: Common Issues & Solutions</h3>
            <button onclick="showSolutions()">Show Solutions</button>
            <div id="solutionsResult" class="result"></div>
        </div>
    </div>

    <script>
        let railwayUrl = '';
        let netlifyUrl = '';

        function updateUrls() {
            railwayUrl = document.getElementById('railwayUrl').value;
            netlifyUrl = document.getElementById('netlifyUrl').value;
            
            if (railwayUrl && netlifyUrl) {
                showResult('railwayResult', '‚úÖ URLs updated successfully!\nRailway: ' + railwayUrl + '\nNetlify: ' + netlifyUrl, 'success');
            } else {
                showResult('railwayResult', '‚ùå Please enter both URLs', 'error');
            }
        }

        async function diagnoseRailway() {
            if (!railwayUrl) {
                showResult('railwayResult', '‚ùå Please enter Railway URL first', 'error');
                return;
            }

            showResult('railwayResult', 'üîÑ Diagnosing Railway backend...', 'warning');
            
            let results = 'üöÄ Railway Backend Diagnostic:\n\n';
            
            // Test health endpoint
            try {
                const healthResponse = await fetch(railwayUrl + '/api/health', {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (healthResponse.ok) {
                    const healthData = await healthResponse.json();
                    results += '‚úÖ Health Check: PASSED\n';
                    results += '   Status: ' + healthData.status + '\n';
                    results += '   Service: ' + healthData.service + '\n';
                } else {
                    results += '‚ùå Health Check: FAILED\n';
                    results += '   Status: ' + healthResponse.status + '\n';
                }
            } catch (error) {
                results += '‚ùå Health Check: ERROR\n';
                results += '   Error: ' + error.message + '\n';
            }

            // Test login endpoint
            try {
                const loginResponse = await fetch(railwayUrl + '/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: 'test@test.com', password: 'test', role: 'admin' })
                });
                
                if (loginResponse.status === 422 || loginResponse.status === 401) {
                    results += '‚úÖ Login Endpoint: AVAILABLE\n';
                    results += '   Status: ' + loginResponse.status + ' (Expected for invalid credentials)\n';
                } else if (loginResponse.status === 404) {
                    results += '‚ùå Login Endpoint: NOT FOUND\n';
                    results += '   Status: 404 - Route not found\n';
                } else {
                    results += '‚ö†Ô∏è Login Endpoint: UNEXPECTED RESPONSE\n';
                    results += '   Status: ' + loginResponse.status + '\n';
                }
            } catch (error) {
                results += '‚ùå Login Endpoint: ERROR\n';
                results += '   Error: ' + error.message + '\n';
            }

            // Test CORS
            try {
                const corsResponse = await fetch(railwayUrl + '/api/health', {
                    method: 'GET',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Origin': netlifyUrl || 'https://test.netlify.app'
                    }
                });
                
                const corsHeaders = {
                    'Access-Control-Allow-Origin': corsResponse.headers.get('Access-Control-Allow-Origin'),
                    'Access-Control-Allow-Methods': corsResponse.headers.get('Access-Control-Allow-Methods'),
                    'Access-Control-Allow-Headers': corsResponse.headers.get('Access-Control-Allow-Headers')
                };
                
                results += '\nüåê CORS Configuration:\n';
                results += '   Allow-Origin: ' + (corsHeaders['Access-Control-Allow-Origin'] || 'Not set') + '\n';
                results += '   Allow-Methods: ' + (corsHeaders['Access-Control-Allow-Methods'] || 'Not set') + '\n';
                results += '   Allow-Headers: ' + (corsHeaders['Access-Control-Allow-Headers'] || 'Not set') + '\n';
            } catch (error) {
                results += '\n‚ùå CORS Test: ERROR\n';
                results += '   Error: ' + error.message + '\n';
            }

            showResult('railwayResult', results, 'info');
        }

        async function diagnoseNetlify() {
            if (!netlifyUrl) {
                showResult('netlifyResult', '‚ùå Please enter Netlify URL first', 'error');
                return;
            }

            showResult('netlifyResult', 'üîÑ Diagnosing Netlify frontend...', 'warning');
            
            let results = 'üåê Netlify Frontend Diagnostic:\n\n';
            
            try {
                const response = await fetch(netlifyUrl, {
                    method: 'GET',
                    headers: { 'Accept': 'text/html' }
                });
                
                if (response.ok) {
                    results += '‚úÖ Frontend Site: ACCESSIBLE\n';
                    results += '   Status: ' + response.status + '\n';
                    results += '   URL: ' + netlifyUrl + '\n';
                    
                    // Check if it's a React app
                    const html = await response.text();
                    if (html.includes('react') || html.includes('vite') || html.includes('index')) {
                        results += '‚úÖ Frontend Type: React/Vite App Detected\n';
                    } else {
                        results += '‚ö†Ô∏è Frontend Type: Unknown/Static Site\n';
                    }
                } else {
                    results += '‚ùå Frontend Site: NOT ACCESSIBLE\n';
                    results += '   Status: ' + response.status + '\n';
                }
            } catch (error) {
                results += '‚ùå Frontend Site: ERROR\n';
                results += '   Error: ' + error.message + '\n';
            }

            // Test if frontend can reach backend
            if (railwayUrl) {
                results += '\nüîó Frontend-Backend Connection Test:\n';
                try {
                    // This will likely fail due to CORS, but we can check the error
                    const testResponse = await fetch(railwayUrl + '/api/health', {
                        method: 'GET',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    
                    if (testResponse.ok) {
                        results += '‚úÖ Backend Reachable: YES\n';
                    } else {
                        results += '‚ö†Ô∏è Backend Reachable: PARTIAL\n';
                        results += '   Status: ' + testResponse.status + '\n';
                    }
                } catch (error) {
                    if (error.message.includes('CORS')) {
                        results += '‚ö†Ô∏è Backend Reachable: CORS ISSUE\n';
                        results += '   This is expected - CORS needs to be configured\n';
                    } else {
                        results += '‚ùå Backend Reachable: NO\n';
                        results += '   Error: ' + error.message + '\n';
                    }
                }
            }

            showResult('netlifyResult', results, 'info');
        }

        async function testIntegration() {
            if (!railwayUrl || !netlifyUrl) {
                showResult('integrationResult', '‚ùå Please enter both URLs first', 'error');
                return;
            }

            showResult('integrationResult', 'üîÑ Testing integration...', 'warning');
            
            let results = 'üîó Integration Test Results:\n\n';
            
            // Test 1: Backend health
            try {
                const healthResponse = await fetch(railwayUrl + '/api/health');
                if (healthResponse.ok) {
                    results += '‚úÖ Backend Health: PASSED\n';
                } else {
                    results += '‚ùå Backend Health: FAILED\n';
                }
            } catch (error) {
                results += '‚ùå Backend Health: ERROR - ' + error.message + '\n';
            }

            // Test 2: Frontend accessibility
            try {
                const frontendResponse = await fetch(netlifyUrl);
                if (frontendResponse.ok) {
                    results += '‚úÖ Frontend Access: PASSED\n';
                } else {
                    results += '‚ùå Frontend Access: FAILED\n';
                }
            } catch (error) {
                results += '‚ùå Frontend Access: ERROR - ' + error.message + '\n';
            }

            // Test 3: API endpoint availability
            try {
                const apiResponse = await fetch(railwayUrl + '/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: 'test', password: 'test', role: 'admin' })
                });
                
                if (apiResponse.status === 404) {
                    results += '‚ùå API Endpoints: NOT FOUND (404)\n';
                    results += '   This indicates routing issues\n';
                } else if (apiResponse.status === 422 || apiResponse.status === 401) {
                    results += '‚úÖ API Endpoints: AVAILABLE\n';
                    results += '   Status: ' + apiResponse.status + ' (Expected for invalid data)\n';
                } else {
                    results += '‚ö†Ô∏è API Endpoints: UNEXPECTED STATUS\n';
                    results += '   Status: ' + apiResponse.status + '\n';
                }
            } catch (error) {
                results += '‚ùå API Endpoints: ERROR - ' + error.message + '\n';
            }

            results += '\nüìä Integration Summary:\n';
            results += '‚Ä¢ Railway Backend: ' + railwayUrl + '\n';
            results += '‚Ä¢ Netlify Frontend: ' + netlifyUrl + '\n';
            results += '‚Ä¢ Next Step: Configure environment variables\n';

            showResult('integrationResult', results, 'info');
        }

        function showChecklist() {
            const checklist = `
üìã Railway + Netlify Deployment Checklist

üöÄ Railway Backend Setup:
‚ñ° Project created on Railway.app
‚ñ° Root directory set to 'backend'
‚ñ° PostgreSQL database added
‚ñ° Environment variables configured:
  ‚ñ° APP_NAME=Everbright Optical System
  ‚ñ° APP_ENV=production
  ‚ñ° APP_DEBUG=false
  ‚ñ° APP_KEY=base64:a4l7XGiTV4ggw1EUKHZGLd22QwavJmOcVnNT38T6GYQ=
  ‚ñ° APP_URL=https://your-railway-backend-url.up.railway.app
  ‚ñ° DB_CONNECTION=pgsql
  ‚ñ° DB_HOST=postgres.railway.internal
  ‚ñ° DB_PORT=5432
  ‚ñ° DB_DATABASE=railway
  ‚ñ° DB_USERNAME=postgres
  ‚ñ° DB_PASSWORD=YOUR_RAILWAY_POSTGRES_PASSWORD
  ‚ñ° SANCTUM_STATEFUL_DOMAINS=your-netlify-site.netlify.app
‚ñ° Service shows "PHP" not "Node"
‚ñ° Deployment successful
‚ñ° Health check passes

üåê Netlify Frontend Setup:
‚ñ° Site created on Netlify.com
‚ñ° Base directory set to 'frontend--'
‚ñ° Build command: npm ci && npm run build
‚ñ° Publish directory: frontend--/dist
‚ñ° Environment variables configured:
  ‚ñ° VITE_API_URL=https://your-railway-backend-url.up.railway.app
  ‚ñ° VITE_API_BASE_URL=https://your-railway-backend-url.up.railway.app/api
  ‚ñ° VITE_APP_NAME=Everbright Optical System
  ‚ñ° VITE_APP_ENV=production
‚ñ° Build successful
‚ñ° Site accessible

üîó Integration:
‚ñ° CORS configured for Netlify domain
‚ñ° Frontend can reach backend
‚ñ° Login functionality works
‚ñ° No 404 errors in console

‚úÖ Success Indicators:
‚ñ° Railway shows "PHP" instead of "Node"
‚ñ° Backend deploys without errors
‚ñ° Frontend builds successfully
‚ñ° API calls work from frontend
‚ñ° No CORS errors in browser console
‚ñ° Login functionality works
            `;

            showResult('checklistResult', checklist, 'info');
        }

        function showSolutions() {
            const solutions = `
üõ†Ô∏è Common Issues & Solutions

‚ùå Railway Issues:

1. "Node" instead of "PHP":
   ‚Ä¢ Check root directory is set to 'backend'
   ‚Ä¢ Ensure no package.json in root directory
   ‚Ä¢ Verify Procfile exists in backend/ directory

2. "composer: command not found":
   ‚Ä¢ Railway is detecting Node.js instead of PHP
   ‚Ä¢ Check root directory configuration
   ‚Ä¢ Verify backend/Procfile exists

3. Database connection errors:
   ‚Ä¢ Check PostgreSQL service is running
   ‚Ä¢ Verify environment variables are set
   ‚Ä¢ Ensure DB_HOST=postgres.railway.internal

4. APP_KEY errors:
   ‚Ä¢ Use: base64:a4l7XGiTV4ggw1EUKHZGLd22QwavJmOcVnNT38T6GYQ=
   ‚Ä¢ Ensure APP_KEY is set in environment variables

‚ùå Netlify Issues:

1. Build failures:
   ‚Ä¢ Check base directory is 'frontend--'
   ‚Ä¢ Verify build command: npm ci && npm run build
   ‚Ä¢ Check Node.js version compatibility

2. 404 errors on API calls:
   ‚Ä¢ Set VITE_API_URL environment variable
   ‚Ä¢ Use your Railway backend URL
   ‚Ä¢ Redeploy after setting variables

3. CORS errors:
   ‚Ä¢ Check Railway CORS configuration
   ‚Ä¢ Verify Netlify domain in SANCTUM_STATEFUL_DOMAINS
   ‚Ä¢ Ensure APP_URL matches Railway URL

üîß Quick Fixes:

1. Railway not detecting PHP:
   ‚Ä¢ Delete any package.json in root
   ‚Ä¢ Set root directory to 'backend'
   ‚Ä¢ Redeploy

2. Frontend 404 errors:
   ‚Ä¢ Set VITE_API_URL in Netlify
   ‚Ä¢ Redeploy Netlify
   ‚Ä¢ Check browser console

3. Database issues:
   ‚Ä¢ Add PostgreSQL service in Railway
   ‚Ä¢ Copy connection details to environment variables
   ‚Ä¢ Redeploy backend

üìû Need Help?
‚Ä¢ Check Railway logs in dashboard
‚Ä¢ Check Netlify build logs
‚Ä¢ Use browser developer tools
‚Ä¢ Test with the integration test tool above
            `;

            showResult('solutionsResult', solutions, 'info');
        }

        function showResult(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = 'result ' + type;
        }
    </script>
</body>
</html>
